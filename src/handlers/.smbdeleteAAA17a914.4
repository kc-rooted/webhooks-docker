const express = require('express');
const crypto = require('crypto');
const MondayClient = require('../utils/mondayClient');
const router = express.Router();

const mondayClient = new MondayClient(process.env.MONDAY_API_TOKEN);

router.post('/', async (req, res) => {
  try {
    const { challenge, event } = req.body;

    if (challenge) {
      console.log('Monday.com webhook challenge received');
      return res.status(200).json({ challenge });
    }

    console.log('Monday.com webhook received:', {
      eventType: event?.type,
      userId: event?.userId,
      boardId: event?.boardId,
      timestamp: new Date().toISOString()
    });

    switch (event?.type) {
      case 'create_item':
        await handleItemCreated(event);
        break;
      case 'update_column_value':
        await handleColumnUpdated(event);
        break;
      case 'create_update':
        await handleUpdateCreated(event);
        break;
      case 'change_status_column_value':
        await handleStatusChanged(event);
        break;
      default:
        console.log(`Unhandled Monday.com event type: ${event?.type}`);
    }

    res.status(200).json({
      success: true,
      message: 'Webhook processed successfully'
    });
  } catch (error) {
    console.error('Error processing Monday.com webhook:', error);
    res.status(500).json({
      success: false,
      error: 'Internal server error'
    });
  }
});

async function handleItemCreated(event) {
  console.log('Processing item creation:', {
    itemId: event.pulseId,
    itemName: event.pulseName,
    boardId: event.boardId
  });

  try {
    if (mondayClient.apiToken) {
      const item = await mondayClient.getItem(event.pulseId);
      console.log('Fetched created item details:', {
        id: item.id,
        name: item.name,
        board: item.board?.name
      });
    }
  } catch (error) {
    console.error('Error fetching item details:', error.message);
  }
}

async function handleColumnUpdated(event) {
  console.log('Processing column update:', {
    itemId: event.pulseId,
    columnId: event.columnId,
    value: event.value
  });
}

async function handleUpdateCreated(event) {
  console.log('Processing update creation:', {
    updateId: event.updateId,
    itemId: event.pulseId
  });
}

async function handleStatusChanged(event) {
  console.log('Processing status change:', {
    itemId: event.pulseId,
    columnId: event.columnId,
    previousValue: event.previousValue,
    value: event.value
  });
}

function verifyMondayWebhook(req) {
  const mondaySignature = req.get('Authorization');
  const secret = process.env.MONDAY_WEBHOOK_SECRET;

  if (!secret || !mondaySignature) {
    return false;
  }

  const body = JSON.stringify(req.body);
  const hash = crypto.createHmac('sha256', secret).update(body).digest('hex');

  return hash === mondaySignature;
}

module.exports = router;